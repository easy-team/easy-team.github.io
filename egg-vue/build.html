<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Egg+ Vue + Webpack 构建流程 | easy-team</title>
    <meta name="description" content="easy-team">
    
    
    <link rel="preload" href="/egg-vue/assets/css/0.styles.6bc51163.css" as="style"><link rel="preload" href="/egg-vue/assets/js/app.2c13058b.js" as="script"><link rel="preload" href="/egg-vue/assets/js/2.396ed812.js" as="script"><link rel="preload" href="/egg-vue/assets/js/26.7b4d63de.js" as="script"><link rel="prefetch" href="/egg-vue/assets/js/10.72b0ea62.js"><link rel="prefetch" href="/egg-vue/assets/js/11.2a5f1d08.js"><link rel="prefetch" href="/egg-vue/assets/js/12.7034d17b.js"><link rel="prefetch" href="/egg-vue/assets/js/13.5238806e.js"><link rel="prefetch" href="/egg-vue/assets/js/14.a7cfc205.js"><link rel="prefetch" href="/egg-vue/assets/js/15.2e2b3e91.js"><link rel="prefetch" href="/egg-vue/assets/js/16.1962a8fc.js"><link rel="prefetch" href="/egg-vue/assets/js/17.3a849eea.js"><link rel="prefetch" href="/egg-vue/assets/js/18.fc72860d.js"><link rel="prefetch" href="/egg-vue/assets/js/19.926b4ef0.js"><link rel="prefetch" href="/egg-vue/assets/js/20.d39624b9.js"><link rel="prefetch" href="/egg-vue/assets/js/21.80801320.js"><link rel="prefetch" href="/egg-vue/assets/js/22.340bd791.js"><link rel="prefetch" href="/egg-vue/assets/js/23.f9718bdb.js"><link rel="prefetch" href="/egg-vue/assets/js/24.1b82a429.js"><link rel="prefetch" href="/egg-vue/assets/js/25.713cf810.js"><link rel="prefetch" href="/egg-vue/assets/js/27.0e085694.js"><link rel="prefetch" href="/egg-vue/assets/js/3.82062db6.js"><link rel="prefetch" href="/egg-vue/assets/js/4.1018a166.js"><link rel="prefetch" href="/egg-vue/assets/js/5.7d3b7cff.js"><link rel="prefetch" href="/egg-vue/assets/js/6.6f624ecf.js"><link rel="prefetch" href="/egg-vue/assets/js/7.7071d0fd.js"><link rel="prefetch" href="/egg-vue/assets/js/8.5a121a1f.js"><link rel="prefetch" href="/egg-vue/assets/js/9.680fad58.js">
    <link rel="stylesheet" href="/egg-vue/assets/css/0.styles.6bc51163.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/egg-vue/" class="home-link router-link-active"><!----> <span class="site-name">easy-team</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/egg-vue/easywebpack.html" class="nav-link">easywebpack</a></div><div class="nav-item"><a href="/egg-vue/egg-vue.html" class="nav-link">egg + vue</a></div><div class="nav-item"><a href="/egg-vue/egg-react.html" class="nav-link">egg + react</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/egg-vue/easywebpack.html" class="nav-link">easywebpack</a></div><div class="nav-item"><a href="/egg-vue/egg-vue.html" class="nav-link">egg + vue</a></div><div class="nav-item"><a href="/egg-vue/egg-react.html" class="nav-link">egg + react</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/egg-vue/case.html" class="sidebar-link">项目一览</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>新手指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-vue/init.html" class="sidebar-link">快速开始</a></li><li><a href="/egg-vue/start.html" class="sidebar-link">从零开始</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/egg-vue/render.html" class="sidebar-heading clickable"><span>渲染模式</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-vue/node.html" class="sidebar-link">服务端渲染模式</a></li><li><a href="/egg-vue/web.html" class="sidebar-link">前端渲染模式</a></li><li><a href="/egg-vue/asset.html" class="sidebar-link">asset 渲染模式</a></li><li><a href="/egg-vue/html.html" class="sidebar-link">HTML前端渲染</a></li></ul></section></li><li><a href="/egg-vue/qpeiow.html" class="sidebar-link">入口实现</a></li><li><a href="/egg-vue/build.html" class="active sidebar-link">构建流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-vue/build.html#_1-背景" class="sidebar-link">1. 背景</a></li><li class="sidebar-sub-header"><a href="/egg-vue/build.html#_2-构建热更新实现" class="sidebar-link">2.构建热更新实现</a></li><li class="sidebar-sub-header"><a href="/egg-vue/build.html#_3-egg-框架中-webpack-构建" class="sidebar-link">3. Egg 框架中 Webpack 构建</a></li></ul></li><li><a href="/egg-vue/online.html" class="sidebar-link">部署流程</a></li><li><a href="/egg-vue/version.html" class="sidebar-link">插件使用</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>特性介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-vue/seo.html" class="sidebar-link">SEO实现</a></li><li><a href="/egg-vue/async.html" class="sidebar-link">异步加载</a></li><li><a href="/egg-vue/typescript.html" class="sidebar-link">TypeScript</a></li><li><a href="/egg-vue/pwa.html" class="sidebar-link">Service Worker</a></li><li><a href="/egg-vue/i18n.html" class="sidebar-link">i18n 国际化支持</a></li><li><a href="/egg-vue/babel.html" class="sidebar-link">Babel 构建优化</a></li></ul></section></li><li><a href="/egg-vue/https:/www.yuque.com/easy-team/ves.html" class="sidebar-link">框架方案</a></li><li><section class="sidebar-group depth-0"><a href="/egg-vue/about.html" class="sidebar-heading clickable"><span>相关问题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-vue/open.html" class="sidebar-link">社区作品</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="基于-egg-vue-webpack-构建流程"><a href="#基于-egg-vue-webpack-构建流程" class="header-anchor">#</a> 基于 Egg+ Vue + Webpack 构建流程</h3> <h2 id="_1-背景"><a href="#_1-背景" class="header-anchor">#</a> 1. 背景</h2> <p style="padding-left:2em;">在用 Node.js + Webpack 构建的方式进行开发时, 我们希望能实现修改代码能实时刷新页面UI的效果. 这个特性 Webpack本身是支持的, 而且基于koa也有现成的 koa-webpack-hot-middleware 和 koa-webpack-dev-middleware 封装好的组件支持.</p><p>不过这里如果需要支持Node.js服务器端修改代码自动重启webpack自动编译功能该如何实现呢, 主要存在以下几个问题:</p><ul><li><p>如何解决 Node.js 服务器端代码修改应用重启避免 Webpack 重新编译.</p></li></ul><ul><li><p>如何访问 js, css, image 等静态资源.</p></li></ul><ul><li><p>服务端渲染时, Node 层如何读取 Webpack 内存编译的内容</p></li></ul><ul><li><p>如何处理本地开发 Webpack 热更新内存存储读取和线上应用本机文件读取逻辑分离.</p></li></ul> <h2 id="_2-构建热更新实现"><a href="#_2-构建热更新实现" class="header-anchor">#</a> 2.构建热更新实现</h2> <blockquote><p>前端渲染和服务端渲染构建热更新实现</p></blockquote><p style="padding-left:2em;">在koa项目中, 通过 koa-webpack-dev-middleware 和 koa-webpack-hot-middleware 可以实现 Webpack 编译内存存储和热更新功能, 代码如下:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-webpack-dev-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hotMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-webpack-hot-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>devMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>hotMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>如果按照上面实现, 可以满足修改修改客户端代码实现webpack自动变编译和UI界面热更新的功能.</p><p>但如果是修改 Node.js 服务器端代码重启后就会发现webpack会重新编译, 这不是我们要的效果.</p><p>原因是因为 middleware 是依赖 app 的生命周期, 当 app 销毁时, 对应 Webpack compiler 实例也就没有了, 重启时会重新执行middleware 初始化工作.</p><p>那有没有办法保持 Webpack 编译实例呢? 针对这个我们可以通过 Egg 框架已经内置了 worke r和 agent 机制来实现 Webpack内存编译功能.</p><ul><li><p>worker 和 agent 通信机制: <a href="https://eggjs.org/zh-cn/core/cluster-and-ipc.html" target="_blank">https://eggjs.org/zh-cn/core/cluster-and-ipc.html</a></p></li></ul><ul><li><p>实现 egg 项目服务器代码修改项目自动重启的功能可以使用 egg-development 插件.</p></li></ul> <h2 id="_3-egg-框架中-webpack-构建"><a href="#_3-egg-框架中-webpack-构建" class="header-anchor">#</a> 3. Egg 框架中 Webpack 构建</h2> <h3 id="_3-1-解决思路"><a href="#_3-1-解决思路" class="header-anchor">#</a> 3.1 解决思路</h3> <ul><li><p>我们利用本地开发修改 Node 层代码修复重启时, 只会重启 Worker 进程, 不会重启 Agent 进程, 我们可以在 Agent 里面启动 Webpack 编译服务解决 Webpack compiler 实例问题.</p></li></ul><ul><li><p>因为 Egg App 进程 和 Agent 进程是两个进程, 当 url 访问时, 我们通过 Worker 发送消息给 Agent 进程, 获取服务端渲染的文件内容, 然后 Agent 再发送消息给 Worker 解决文件读取问题.</p></li></ul><ul><li><p>本地开发 Webpack 热更新内存存储读取和线上应用本机文件读取逻辑分离功能, 我们通过本地开发模式时, 通过读取Webpack 内存内容覆盖本地文件读取的逻辑, 这样在开发模式和发布模式可以无缝对接.</p></li></ul> <h3 id="_3-2-本地开发模式"><a href="#_3-2-本地开发模式" class="header-anchor">#</a> 3.2 本地开发模式</h3> <h4 id="_3-2-1-egg项目启动"><a href="#_3-2-1-egg项目启动" class="header-anchor">#</a> 3.2.1 Egg项目启动</h4> <p><img src="https://cdn.yuque.com/yuque/0/2018/png/116733/1528521824273-8fc185c1-8124-4422-919e-33341ebff8c3.png#width=827" style="max-width:600px;width:827px;"></p><ul><li><p>首先执行<code>node index.js</code> 或者 <code>npm run dev</code> 启动 Egg 应用</p></li></ul><ul><li><p>在 Egg Agent 里面启动 koa 服务, 同时在koa服务里面启动 Webpack 编译服务</p></li></ul><ul><li><p>挂载 Webpack 内存文件读取方法覆盖本地文件读取的逻辑</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span>vue<span class="token punctuation">.</span><span class="token function-variable function">renderBundle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">?</span> name <span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>view<span class="token punctuation">.</span>root<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">const</span> promise <span class="token operator">=</span> app<span class="token punctuation">.</span>webpack<span class="token punctuation">.</span>fileSystem<span class="token punctuation">.</span><span class="token function">readWebpackMemoryFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">yield</span> promise<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">read webpack memory file[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] content is empty, please check if the file exists</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token function">renderBundle</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>vue<span class="token punctuation">)</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> context<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>Worker 监听 Webpack 编译状态, 检测 Webpack 编译是否完成, 如果未完成, 显示 Webpack 编译 Loading, 如果编译完成, 自动打开浏览器</p></li></ul><ul><li><p>Webpack 编译完成, Agent 发送消息给 Worker,  Worker 检测到编译完成, 自动打开浏览器, Egg 服务正式可用</p></li></ul> <h4 id="_3-2-2-本地开发服务端渲染页面访问"><a href="#_3-2-2-本地开发服务端渲染页面访问" class="header-anchor">#</a> 3.2.2 本地开发服务端渲染页面访问</h4> <p><img src="https://cdn.yuque.com/yuque/0/2018/png/116733/1528521836714-be7dd0fe-f89d-4a50-af97-902f1d0fe50f.png#width=827" style="max-width:600px;width:827px;"></p><ul><li><p>浏览器输入URL请求地址, 然后Egg接收到请求, 然后进入Controller</p></li></ul><ul><li><p>Node层获取数据后(Node通过http/rpc方式调用Java后端API数据接口), 进入模板render流程</p></li></ul><ul><li><p>进入render流程后, 通过worker进程通过调用 <code>app.messenger.sendToAgent</code> 发送文件名给Agent进程, 同时通过 <code>app.messenger.on</code> 启动监听监听agent发送过来的消</p></li></ul><ul><li><p>Agent进程获取到文件名后, 从Webpack编译内存里面获取文件内容, 然后Agent 通过 <code>agent.messenger.sendToApp</code> 把文件内容发送给Worker进程</p></li></ul><ul><li><p>Worker进程获取到内容以后, 进行Vue编译HTML, 编译成HTML后, 进入jss/css资源依赖流程</p></li></ul><ul><li><p>如果启动代理模式(见easywebpack的setProxy),  HTML直接注入相对路径的JS/CSS, 如下:</p><p>      页面可以直接使用 <code>/public/client/js/vendor.js</code> 相对路径,  <code>/public/client/js/vendor.js</code> 由后端框架代理转发到webpack编译服务, 然后返回内容给后端框架, 这里涉及两个应用通信. 如下:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/public/client/css/home/android/home.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;/public/client/js/vendor.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;/public/client/js/home.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span> 
</code></pre></div></li></ul><ul><li><p>如果非代理模式,  HTML直接注入必须是绝对路径的 JS/CSS , 如下:</p><blockquote><p>页面必须使用 <code>http://127.0.0.1:9001/public/client/js/vendor.js</code> 绝对路径</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://127.0.0.1:9001/public/client/css/home/android/home.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:9001/public/client/js/vendor.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:9001/public/client/js/home.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span> 
</code></pre></div><p>其中 <a href="http://127.0.0.1:9001" target="_blank">http://127.0.0.1:9001</a> 是 Agent里面启动的Webpack编译服务地址, 与Egg应用地址是两回事</p></li></ul><ul><li><p>最后, 模板渲染完成, 服务器输出HTML内容给浏览器.</p></li></ul> <h3 id="_4-发布模式构建流程和运行模式"><a href="#_4-发布模式构建流程和运行模式" class="header-anchor">#</a> 4. 发布模式构建流程和运行模式</h3> <ul><li><p>easywebpack 通过本地构建或者ci直接构建好服务端和客户端渲染文件到磁盘, 命令是 <code>easy build prod</code></p></li></ul><ul><li><p>Egg render 直接读取本地文件, 然后渲染成 HTML.</p></li></ul><ul><li><p>根据 <code>manfifest.json</code> 文件注入 jss/css 资源依赖注入.</p></li></ul><ul><li><p>模板渲染完成, 服务器输出HTML内容给浏览器.</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/egg-vue/qpeiow.html" class="prev">入口实现</a></span> <span class="next"><a href="/egg-vue/online.html">部署流程</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/egg-vue/assets/js/app.2c13058b.js" defer></script><script src="/egg-vue/assets/js/2.396ed812.js" defer></script><script src="/egg-vue/assets/js/26.7b4d63de.js" defer></script>
  </body>
</html>
