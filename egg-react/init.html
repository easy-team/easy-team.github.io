<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Egg + React + Webpack 服务端渲染开发指南 | Egg + React  工程化解决方案</title>
    <meta name="description" content="Egg + React 工程化解决方案, 支持 Egg + React 服务端渲染(Server Side Render) 和 前端渲染模式. GitHub: https://github.com/easy-team/egg-react-webpack-boilerplate">
    
    
    <link rel="preload" href="/egg-react/assets/css/0.styles.803b77c2.css" as="style"><link rel="preload" href="/egg-react/assets/js/app.54578750.js" as="script"><link rel="preload" href="/egg-react/assets/js/2.67c62971.js" as="script"><link rel="preload" href="/egg-react/assets/js/19.b75580c8.js" as="script"><link rel="prefetch" href="/egg-react/assets/js/10.af30a2a4.js"><link rel="prefetch" href="/egg-react/assets/js/11.3488386f.js"><link rel="prefetch" href="/egg-react/assets/js/12.59b9189b.js"><link rel="prefetch" href="/egg-react/assets/js/13.4acfcdfb.js"><link rel="prefetch" href="/egg-react/assets/js/14.832099be.js"><link rel="prefetch" href="/egg-react/assets/js/15.e4d419be.js"><link rel="prefetch" href="/egg-react/assets/js/16.21bdbc21.js"><link rel="prefetch" href="/egg-react/assets/js/17.4e28f88d.js"><link rel="prefetch" href="/egg-react/assets/js/18.1583aeaf.js"><link rel="prefetch" href="/egg-react/assets/js/20.31b55d0c.js"><link rel="prefetch" href="/egg-react/assets/js/21.196dfafe.js"><link rel="prefetch" href="/egg-react/assets/js/22.9ce04c0f.js"><link rel="prefetch" href="/egg-react/assets/js/3.407b0684.js"><link rel="prefetch" href="/egg-react/assets/js/4.e73e36c5.js"><link rel="prefetch" href="/egg-react/assets/js/5.3cdbf2bc.js"><link rel="prefetch" href="/egg-react/assets/js/6.cc5f66ae.js"><link rel="prefetch" href="/egg-react/assets/js/7.71771cc7.js"><link rel="prefetch" href="/egg-react/assets/js/8.450a860c.js"><link rel="prefetch" href="/egg-react/assets/js/9.d47f63fa.js">
    <link rel="stylesheet" href="/egg-react/assets/css/0.styles.803b77c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/egg-react/" class="home-link router-link-active"><!----> <span class="site-name">Egg + React  工程化解决方案</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/egg-react/easywebpack.html" class="nav-link">easywebpack</a></div><div class="nav-item"><a href="/egg-react/egg-vue.html" class="nav-link">egg + vue</a></div><div class="nav-item"><a href="/egg-react/egg-react.html" class="nav-link">egg + react</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/egg-react/easywebpack.html" class="nav-link">easywebpack</a></div><div class="nav-item"><a href="/egg-react/egg-vue.html" class="nav-link">egg + vue</a></div><div class="nav-item"><a href="/egg-react/egg-react.html" class="nav-link">egg + react</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-react/init.html" class="active sidebar-link">快速开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-react/init.html#基于-egg-react-webpack-服务端渲染开发指南" class="sidebar-link">基于 Egg + React + Webpack 服务端渲染开发指南</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_1-项目初始化" class="sidebar-link">1. 项目初始化</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_2-项目运行" class="sidebar-link">2. 项目运行</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_3-项目构建" class="sidebar-link">3. 项目构建</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_4-项目规范" class="sidebar-link">4. 项目规范</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_5-项目开发" class="sidebar-link">5. 项目开发</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_6-项目部署" class="sidebar-link">6. 项目部署</a></li><li class="sidebar-sub-header"><a href="/egg-react/init.html#_8-项目和插件" class="sidebar-link">8. 项目和插件</a></li></ul></li><li><a href="/egg-react/start.html" class="sidebar-link">从零开始</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/egg-react/render.html" class="sidebar-heading clickable"><span>渲染模式</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-react/node.html" class="sidebar-link">服务端渲染模式</a></li><li><a href="/egg-react/web.html" class="sidebar-link">前端渲染模式</a></li><li><a href="/egg-react/asset.html" class="sidebar-link">asset 前端渲染</a></li></ul></section></li><li><a href="/egg-react/config.html" class="sidebar-link">配置说明</a></li><li><a href="/egg-react/build.html" class="sidebar-link">构建流程</a></li><li><a href="/egg-react/online.html" class="sidebar-link">部署流程</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>特性介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-react/seo.html" class="sidebar-link">SEO实现</a></li><li><a href="/egg-react/pwa.html" class="sidebar-link">Service Worker</a></li><li><a href="/egg-react/https:/www.yuque.com/hubcarl/easywebpack/cssmodule.html" class="sidebar-link">Css Module</a></li><li><a href="/egg-react/babel.html" class="sidebar-link">Babel 配置</a></li><li><a href="/egg-react/antd.html" class="sidebar-link">AntD 配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/egg-react/version.html" class="sidebar-heading clickable"><span>插件版本</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/egg-react/about.html" class="sidebar-link">常见问题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h2 id="基于-egg-react-webpack-服务端渲染开发指南"><a href="#基于-egg-react-webpack-服务端渲染开发指南" aria-hidden="true" class="header-anchor">#</a> 基于 Egg + React + Webpack 服务端渲染开发指南</h2> <h2 id="_1-项目初始化"><a href="#_1-项目初始化" aria-hidden="true" class="header-anchor">#</a> 1. 项目初始化</h2> <h3 id="_1-1-通过-easywebpack-cli-脚手架初始化"><a href="#_1-1-通过-easywebpack-cli-脚手架初始化" aria-hidden="true" class="header-anchor">#</a> 1.1 通过 easywebpack-cli 脚手架初始化</h3> <ol start="1"><li><p>安装脚手架 <code>npm install easywebpack-cli -g</code> 命令行，然后就可以使用 <code>easywebpack</code> 或 <code>easy</code> 命令</p></li></ol><ol start="2"><li><p>命令行运行 <code>easywebpack init</code></p></li></ol><ol start="3"><li><p>选择 egg + react server side render boilerplate 初始化骨架项目</p></li></ol><ol start="4"><li><p>安装依赖 <code>npm install</code></p></li></ol> <h3 id="_1-2-通过骨架项目初始化"><a href="#_1-2-通过骨架项目初始化" aria-hidden="true" class="header-anchor">#</a> 1.2 通过骨架项目初始化</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/easy-team/egg-react-webpack-boilerplate.git
<span class="token function">npm</span> <span class="token function">install</span> 
</code></pre></div><p>初始化的项目提供多页面和SPA(react-router/react-redux)服务端渲染实例，可以直接运行。</p> <h3 id="_1-3-vscode-插件初始化项目"><a href="#_1-3-vscode-插件初始化项目" aria-hidden="true" class="header-anchor">#</a> 1.3 vscode 插件初始化项目</h3> <p style="padding-left:2em;"><a href="https://marketplace.visualstudio.com/items?itemName=hubcarl.vscode-easy-plugin#overview" target="_blank">https://marketplace.visualstudio.com/items?itemName=hubcarl.vscode-easy-plugin#overview</a></p><p style="padding-left:2em;"><br></p> <h2 id="_2-项目运行"><a href="#_2-项目运行" aria-hidden="true" class="header-anchor">#</a> 2. 项目运行</h2> <h3 id="_2-1-本地运行"><a href="#_2-1-本地运行" aria-hidden="true" class="header-anchor">#</a> 2.1 本地运行</h3> <div class="language-undefined extra-class"><pre class="language-text"><code>npm run dev 
</code></pre></div><p>npm run dev 做了如下三件事情</p><ul><li><p>启动 egg 应用</p></li></ul><ul><li><p>启动 Webpack 构建, 文件不落地磁盘，构建的文件都在内存里面(只在本地启动, 发布模式是提前构建好文件到磁盘)</p></li></ul><ul><li><p>构建会同时启动两个 Webpack 构建服务, 客户端js构建端口9000, 服务端端口9001</p></li></ul><ul><li><p>构建完成，Egg应用正式可用，自动打开浏览器</p></li></ul> <h3 id="_2-2-发布模式"><a href="#_2-2-发布模式" aria-hidden="true" class="header-anchor">#</a> 2.2 发布模式</h3> <ul><li><p>构建文件落地磁盘</p></li></ul> <div class="language-undefined extra-class"><pre class="language-text"><code>npm run build 或 easywebpack build prod 
</code></pre></div><ol start="1"><li><p>启动 Webpack 构建，文件落地磁盘</p></li></ol><ol start="2"><li><p>服务端构建的文件放到 <code>app/view</code> 目录</p></li></ol><ol start="3"><li><p>客户端构建的文件放到 <code>public</code> 目录</p></li></ol><ol start="4"><li><p>生成的 <code>manifest.json</code> 放到 <code>config</code> 目录</p></li></ol><ol start="5"><li><p>构建的文件都是 <code>gitignore</code>的，部署时请注意把这些文件打包进去</p></li></ol><ul><li><p>运行</p></li></ul><p>启动应用前， 请设置 <code>EGG_SERVER_ENV</code> 环境变量，测试环境设置 <code>test</code>， 正式环境设置 <code>prod</code></p> <div class="language-undefined extra-class"><pre class="language-text"><code>npm start 
</code></pre></div><h2 id="_3-项目构建"><a href="#_3-项目构建" aria-hidden="true" class="header-anchor">#</a> 3. 项目构建</h2> <ul><li><p>通过 <code>easywebpack-cli</code> 统一构建，支持 dev，test，prod 模式构建</p></li></ul><ul><li><p><code>easywebpack-cli</code> 通过项目根目录下的 <code>webpack.config.js</code> 配置文件构造出 Webpack 实际的配置文件，配置项请见 <a href="https://www.yuque.com/easy-team/easywebpack/config" target="_blank">webpack.config.js</a></p></li></ul><ul><li><p>获取 Webpack 实际的配置文件, <a href="https://github.com/easy-webpack/egg-webpack" target="_blank">egg-webpack</a> 会使用到该功能。构建会根据 <code>webpackConfigList.length</code> 启动对应个数的 Webpack 编译实例，这里会同时启动两个 Webpack 构建服务, 客户端jsbundle构建，端口9000, 服务端jsbundle构建端口9001。默认端口为9000, 端口依次递增。</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/config.local.js 本地 npm start 使用</span>
<span class="token keyword">const</span> EasyWebpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'easywebpack-react'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>webpack <span class="token operator">=</span> <span class="token punctuation">{</span>
 webpackConfigList<span class="token punctuation">:</span>EasyWebpack<span class="token punctuation">.</span><span class="token function">getWebpackConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>该项目中，<code>app/web/page</code> 目录中所有 .jsx 文件当作 Webpack 构建入口是采用 app/web/framework/entry/loader.js 模板实现的，这个需要结合 <code>webpack.config.js</code> 下的 entry.loader 使用。</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
   include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'app/web/page'</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> layout<span class="token punctuation">:</span> <span class="token string">'app/web/view/layout.jsx?loader=false'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> <span class="token string">'spa/redux'</span><span class="token punctuation">:</span> <span class="token string">'app/web/page/spa/redux.jsx?loader=false'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> <span class="token string">'spa/client'</span><span class="token punctuation">:</span> <span class="token string">'app/web/page/spa/client.jsx?loader=false'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> <span class="token string">'spa/ssr'</span><span class="token punctuation">:</span> <span class="token string">'app/web/page/spa/ssr.jsx?loader=false'</span> <span class="token punctuation">}</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'app/web/page/test'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   loader<span class="token punctuation">:</span> <span class="token punctuation">{</span>
     client<span class="token punctuation">:</span> <span class="token string">'app/web/framework/entry/loader.js'</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>上面 <code>{ 'app/app': 'app/web/page/app/app.js?loader=false' }</code> 这个 <code>loader=false</code> 的含义表示 <code>app/web/page</code> 目录下的 <code>app/app.js</code> 不使用 entry.loader 模板。因为这个app/app.js是一个SPA服务端渲染Example，实现逻辑与其他普通的页面不一样，不能用 entry.loader 模板， 这个功能在自定义entry文件构建规范时使用。</p> <h2 id="_4-项目规范"><a href="#_4-项目规范" aria-hidden="true" class="header-anchor">#</a> 4. 项目规范</h2> <ul><li><p><a href="https://eggjs.org/zh-cn/basics/structure.html" target="_blank">遵循 egg 开发规范</a></p></li></ul><ul><li><p>React 项目代码放到 app/web 目录，页面入口目录为 page，该目录的 所有 .jsx 文件默认会作为 Webpack 的 entry 构建入口。建议每个页面目录的只保留一个.jsx 文件，jsx关联的组件可以放到widget 或者 component 目录。如果非要放到当前目前，请配置 <code>webpack.config.js</code> entry.exclude 排除 .jsx 文件。</p></li></ul> <h2 id="_5-项目开发"><a href="#_5-项目开发" aria-hidden="true" class="header-anchor">#</a> 5. 项目开发</h2> <p>支持多页面/单页面服务端渲染, 前端渲染, 静态页面三种方式.</p> <h3 id="_5-1-多页面服务端渲染实现"><a href="#_5-1-多页面服务端渲染实现" aria-hidden="true" class="header-anchor">#</a> 5.1 多页面服务端渲染实现</h3> <h4 id="_5-1-1-多页面前端页面实现"><a href="#_5-1-1-多页面前端页面实现" aria-hidden="true" class="header-anchor">#</a> 5.1.1 多页面前端页面实现</h4> <p>在app/web/page 目录下面创建home目录, home.jsx 文件, Webpack自动根据.jsx 文件创建entry入口, 具体实现请见<a href="https://www.yuque.com/easy-team/easywebpack/config" target="_blank">webpack.config.js</a></p><ul><li><p>home.jsx 以组件的方式实现页面逻辑</p></li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Header <span class="token keyword">from</span> <span class="token string">'component/layout/standard/header/header.jsx'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> List <span class="token keyword">from</span> <span class="token string">'component/home/list.jsx'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./home.css'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Home</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
 <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----componentDidMount-----'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">classname</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">classname</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>page-container page-component<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span> <span class="token attr-name">list</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{this.props.list}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> 
</code></pre></div><h4 id="_5-1-2-多页面后端渲染实现-通过-egg-view-react-ssr-插件-render-方法实现"><a href="#_5-1-2-多页面后端渲染实现-通过-egg-view-react-ssr-插件-render-方法实现" aria-hidden="true" class="header-anchor">#</a> 5.1.2 多页面后端渲染实现, 通过 egg-view-react-ssr 插件 render 方法实现</h4> <ul><li><p>创建controller文件home.js</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">index</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">yield</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home/home.js'</span><span class="token punctuation">,</span> Model<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>添加路由配置</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h4 id="_5-1-3-多页面走前端渲染-后端路由-实现-通过-egg-view-react-ssr-插件-renderclient-方法实现"><a href="#_5-1-3-多页面走前端渲染-后端路由-实现-通过-egg-view-react-ssr-插件-renderclient-方法实现" aria-hidden="true" class="header-anchor">#</a> 5.1.3 多页面走前端渲染(后端路由)实现, 通过 egg-view-react-ssr 插件 renderClient 方法实现</h4> <ul><li><p>创建controller文件home.js</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">client</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">yield</span> ctx<span class="token punctuation">.</span><span class="token function">renderClient</span><span class="token punctuation">(</span><span class="token string">'home/home.js'</span><span class="token punctuation">,</span> Model<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>添加路由配置</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/client'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>home<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="_5-2-html静态页面前端渲染"><a href="#_5-2-html静态页面前端渲染" aria-hidden="true" class="header-anchor">#</a> 5.2 HTML静态页面前端渲染</h3> <ul><li><p>直接有easywebpack构建出静态HTML文件, 请见 <code>webpack.config.js</code> 配置和 <code>app/web/page/html</code>代码实现</p></li></ul><ul><li><p>通过 <code>egg-static</code> 静态文件访问HTML文件</p></li></ul> <h3 id="_5-3-单页面服务器渲染同构实现"><a href="#_5-3-单页面服务器渲染同构实现" aria-hidden="true" class="header-anchor">#</a> 5.3 单页面服务器渲染同构实现</h3> <h4 id="_5-3-1-单页面前端实现"><a href="#_5-3-1-单页面前端实现" aria-hidden="true" class="header-anchor">#</a> 5.3.1 单页面前端实现</h4> <p>在app/web/page 目录下面创建app目录, spa/ssr.jsx 文件.</p><ul><li><p>ssr.jsx 页面调用入口</p></li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>match<span class="token punctuation">,</span> RouterContext<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter<span class="token punctuation">,</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> matchRoutes<span class="token punctuation">,</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span>
<span class="token keyword">import</span> Header <span class="token keyword">from</span> <span class="token string">'component/layout/standard/header/header'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token constant">SSR</span> <span class="token keyword">from</span> <span class="token string">'component/spa/ssr/ssr'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'component/spa/ssr/store'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'component/spa/ssr/routes'</span>
<span class="token keyword">import</span> <span class="token string">'./spa.css'</span><span class="token punctuation">;</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 前端渲染构建</span>
 <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">const</span> url <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>url<span class="token punctuation">;</span>
 ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     &lt;provider store=&quot;{&quot; }&gt;
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>browserrouter</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         &lt;ssr url=&quot;{&quot; }&gt;
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ssr</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>browserrouter</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>provider</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
   document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 服务端渲染构建和render入口, 这里 export 函数，服务端会负责处理</span>
 module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> url <span class="token operator">=</span> context<span class="token punctuation">.</span>state<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
   <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取组件数据</span>
   <span class="token keyword">const</span> promises <span class="token operator">=</span> branch<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span>route<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> fetch <span class="token operator">=</span> route<span class="token punctuation">.</span>component<span class="token punctuation">.</span>fetch<span class="token punctuation">;</span>
     <span class="token keyword">return</span> fetch <span class="token keyword">instanceof</span> <span class="token class-name">Function</span> <span class="token operator">?</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token comment">// 初始化store数据</span>
     <span class="token keyword">const</span> initState <span class="token operator">=</span> context<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
     data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>initState<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     context<span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>state<span class="token punctuation">,</span> initState<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>initState<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">(</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provider</span> <span class="token attr-name">store</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{store}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
           </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>staticrouter</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{url}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
             </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ssr</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{url}/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
           </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ssr</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>staticrouter</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>provider</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
     <span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><h4 id="_5-3-2-单页面后端实现"><a href="#_5-3-2-单页面后端实现" aria-hidden="true" class="header-anchor">#</a> 5.3.2 单页面后端实现</h4> <ul><li><p>创建controller文件app.js</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">ssr</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">yield</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'spa/ssr.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>添加路由配置</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/spa/ssr'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>spa<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>构建配置</p></li></ul><p>spa 单页面实现复杂，不能使用 entry.loader, 所以需要在 <code>webpack.config.js</code> 配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
 entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
   include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'app/web/page'</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> layout<span class="token punctuation">:</span> <span class="token string">'app/web/view/layout.jsx?loader=false'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> <span class="token string">'spa/redux'</span><span class="token punctuation">:</span> <span class="token string">'app/web/page/spa/redux.jsx?loader=false'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> <span class="token string">'spa/client'</span><span class="token punctuation">:</span> <span class="token string">'app/web/page/spa/client.jsx?loader=false'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> <span class="token string">'spa/ssr'</span><span class="token punctuation">:</span> <span class="token string">'app/web/page/spa/ssr.jsx?loader=false'</span> <span class="token punctuation">}</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'app/web/page/test'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   loader<span class="token punctuation">:</span> <span class="token punctuation">{</span>
     client<span class="token punctuation">:</span> <span class="token string">'app/web/framework/entry/loader.js'</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>详细代码请参考<a href="https://github.com/hubcarl/egg-react-webpack-boilerplate/blob/master/app/web/page/spa/ssr.jsx" target="_blank">骨架项目实现</a></p> <h2 id="_6-项目部署"><a href="#_6-项目部署" aria-hidden="true" class="header-anchor">#</a> 6. 项目部署</h2> <ul><li><p>正式环境部署，请设置 <code>EGG_SERVER_ENV=prod</code> 环境变量, 更多请见<a href="https://eggjs.org/zh-cn/basics/env.html" target="_blank">运行环境</a></p></li></ul><ul><li><p>构建的 <code>app/view</code> 目录, <code>public</code> 目录以及 <code>buildConfig.json</code> 和 <code>manifest.json</code>等文件, 都是 <code>gitignore</code> 的，部署时请注意把这些文件打包进去。</p></li></ul> <h3 id="一-webpack构建目录"><a href="#一-webpack构建目录" aria-hidden="true" class="header-anchor">#</a> 一. Webpack构建目录</h3> <ul><li><p>Webpack构建服务端(Node) JSBundle运行文件, 构建的服务端渲染模板文件位置 <code>${app_root}/app/view</code></p></li></ul><ul><li><p>Webpack构建浏览器JSBundle运行文件, 构建的前端资源(js/css/image)文件位置 <code>${app_root}/public</code></p></li></ul><ul><li><p>Webpack构建的 <code>manifest.json</code> 和 <code>buildConfig.js</code> 文件位置 <code>${app_root}/config</code> 目录</p></li></ul><ul><li><p>easywebpack-cli 构建配置文件 <code>webpack.config.js</code> 放到项目根目录<code>${app_root}/webpack.config.js</code></p></li></ul><ul><li><p>React代码文件<code>${app_root}/app/web</code> 下面, 主要包括 <code>asset</code>, <code>component</code>, <code>framework</code>, <code>page</code>, <code>store</code>, <code>view</code> 等目录</p></li></ul> <div class="language-undefined extra-class"><pre class="language-text"><code>├── asset                    // 资源文件
   │   ├── css 
   │   │   ├── global.css
   │   │   ├── normalize.css
   │   │   └── style.css
   │   ├── images
   │   │   ├── favicon.ico
   │   │   ├── loading.gif
   │   │   └── logo.png
   ├── component                // jsx组件
   │   ├── home
   │   │   └── list.jsx
   │   └── layout
   │       └── standard
   │           └── header
   │               ├── header.css
   │               └── header.jsx
   ├── framework
   │   └── entry
   │       ├── app.js
   │       └── loader.js
   ├── page               // 页面目录, jsx结尾的的文件默认作为entry入口
   │   ├── hello
   │   │   └── hello.jsx  // 页面入口文件, 根据framework/entry/loader.js模板自动构建
   │   └── home
   │       ├── home.css
   │       └── home.jsx
   └── view
       └── layout.jsx     // layout模板文件, 提供统一html, header, body结构, page下面的jsx文件无需关心 
</code></pre></div><h3 id="二-项目结构和基本规范"><a href="#二-项目结构和基本规范" aria-hidden="true" class="header-anchor">#</a> 二. 项目结构和基本规范</h3> <div class="language-undefined extra-class"><pre class="language-text"><code>├── app
│   ├── controller
│   │   ├── test
│   │   │   └── test.js
│   ├── extend
│   ├── lib
│   ├── middleware
│   ├── mocks
│   ├── proxy
│   ├── router.js
│   ├── view
│   │   ├── about                         // 服务器编译的jsbundle文件
│   │   │   └── about.js
│   │   ├── home
│   │   │     └── home.js                 // 服务器编译的jsbundle文件
│   │   └── layout.js                     // 编译的layout文件
│   └── web                               // 前端工程目录
│       ├── asset                         // 存放公共js,css资源
│       ├── framework                     // 前端公共库和第三方库
│       │   └── entry                          
│       │       ├── loader.js              // 根据jsx文件自动生成entry入口文件loader
│       ├── page                           // 前端页面和webpack构建目录, 也就是webpack打包配置entryDir
│       │   ├── home                       // 每个页面遵循目录名, js文件名, scss文件名, jsx文件名相同
│       │   │   ├── home.scss
│       │   │   ├── home.jsx
│       │   └── hello                      // 每个页面遵循目录名, js文件名, scss文件名, jsx文件名相同
│       │       ├── test.css               // 服务器render渲染时, 传入 render('test/test.js', data)
│       │       └── test.jsx
│       ├── store                             
│       │   ├── app
│       │   │   ├── actions.js
│       │   │   ├── getters.js
│       │   │   ├── index.js
│       │   │   ├── mutation-type.js
│       │   │   └── mutations.js
│       │   └── store.js
│       └── component                         // 公共业务组件, 比如loading, toast等, 遵循目录名, js文件名, scss文件名, jsx文件名相同
│           ├── loading
│           │   ├── loading.scss
│           │   └── loading.jsx
│           ├── test
│           │   ├── test.jsx
│           │   └── test.scss
│           └── toast
│               ├── toast.scss
│               └── toast.jsx
├── config
│   ├── config.default.js
│   ├── config.local.js
│   ├── config.prod.js
│   ├── config.test.js
│   └── plugin.js
├── doc
├── index.js
├── webpack.config.js                      // easywebpack-cli 构建配置
├── public                                 // webpack编译目录结构, render文件查找目录
│   ├── static
│   │   ├── css
│   │   │   ├── home
│   │   │   │   ├── home.07012d33.css
│   │   │   └── test
│   │   │       ├── test.4bbb32ce.css
│   │   ├── img
│   │   │   ├── change_top.4735c57.png
│   │   │   └── intro.0e66266.png
│   ├── test
│   │   └── test.js
│   └── vendor.js                         // 生成的公共打包库 
</code></pre></div><h2 id="_8-项目和插件"><a href="#_8-项目和插件" aria-hidden="true" class="header-anchor">#</a> 8. 项目和插件</h2> <ul><li><p><a href="https://github.com/easy-team/egg-react-webpack-boilerplate" target="_blank">egg-react-webpack-boilerplate</a>基于easywebpack-react和egg-view-react(ssr)插件的工程骨架项目</p></li></ul><ul><li><p><a href="https://github.com/easy-team/easywebpack-react" target="_blank">easywebpack-react</a> Webpack React 构建工程化方案.</p></li></ul><ul><li><p><a href="https://github.com/easy-team/easywebpack-cli" target="_blank">easywebpack-cli</a>  Webpack 构建工程化脚手架.</p></li></ul><ul><li><p><a href="https://github.com/easy-team/egg-view-vue-ssr" target="_blank">egg-view-react-ssr</a> react ssr 解决方案.</p></li></ul><ul><li><p><a href="https://github.com/easy-team/egg-webpack" target="_blank">egg-webpack</a> 本地开发热更新使用.</p></li></ul><ul><li><p><a href="https://github.com/easy-team/egg-webpack-react" target="_blank">egg-webpack-react</a> 本地开发渲染内存读取辅助插件</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/egg-react/start.html">
          从零开始
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/egg-react/assets/js/app.54578750.js" defer></script><script src="/egg-react/assets/js/2.67c62971.js" defer></script><script src="/egg-react/assets/js/19.b75580c8.js" defer></script>
  </body>
</html>
